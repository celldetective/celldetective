Spreading assay experiment in GUI
=================================

.. _spreading-assay-example:

Download the demo experiment
----------------------------

We provide two demo experiments in `Zenodo`_ :

.. _Zenodo : https://zenodo.org/records/10650279

#. an ADCC experiment (``demo_adcc``): we imaged a co-culture of MCF-7 and human primary NK cells, in the presence of antibodies
#. a spreading assay experiment (``demo_ricm``): we imaged in RICM human primary NK cells spreading on a surface covered with antibodies

Download the ``demo_ricm.zip`` file and put it anywhere in your computer. Extract the content. The resulting folder, containing a well ``W1/``, a ``configs`` folder and a ``config.ini`` file is a valid experiment folder, ready to be opened by Celldetective. 

Open a terminal and type the following to launch the software:

.. code-block:: console

    $ (conda activate celldetective_env)
    $ python -m celldetective

Press the ``Browse`` button and locate the ``demo_ricm`` folder. Click on ``Open``. 

You can select position 100 and click on the image icon that becomes active on the right side to view the stack.


Segment
-------

For the spreading assay, we are interested in one population only: effector cells spreading on an antigen-presenting-cell-mimicking surface. 

Expand the ``PROCESS EFFECTORS`` block.

Threshold segmentation
~~~~~~~~~~~~~~~~~~~~~~

You can click on the ``UPLOAD`` button of the segmentation module, toggle the ``Threshold`` option and press ``Choose File`` to locate a threshold segmentation configuration file. These are generated by the ``Threshold Config Wizard`` also reachable here. You can find a valid config file in ``demo_ricm/configs/threshold_config_effectors.json``. Select it and upload it by pressing ``Upload``.

This action sets these threshold instructions for the ``Threshold`` segmentation method in Celldetective. These instructions are forgotten as soon as you close the current experiment. To apply them to a movie:

1) toggle the ``SEGMENT`` option, if not already done
2) select the ``Threshold`` option in the model zoo for segmentation
3) press ``Submit`` to launch the job to the positions selected at the top

Deep-learning segmentation
~~~~~~~~~~~~~~~~~~~~~~~~~~

1) toggle the ``SEGMENT`` option
2) select either the ``ricm_lymphocytes`` or ``bimodal_spreading_lymphocytes`` model in the model zoo for segmentation
3) press ``Submit`` to launch the job to the positions selected at the top

Quality check
~~~~~~~~~~~~~

The GUI freezes during the segmentation process. The steps are shown in the terminal. Upon completion, you can select a single position to enable the eye icon in the segmentation module. The latter launches napari to view the original stack and the segmentation labels. 

You can click on the ``Image`` layer on the left side and play with the contrast slider to recontrast the image. If you select the ``segmentation`` layer you have access to a toolkit to create new masks, correct existing masks or erase masks. On the right side you can either save the modifications to the mask or export an annotation sample for the current frame (or crop of the current frame).

Track
-----

You can now click on the configuration button in the tracking module to view or modify the tracking settings. Here we use a custom bTrack configuration named "ricm" that removes branching and apoptosis hypotheses and assumes a very low segmentation miss rate. 

It is recommended to keep the ``FEATURES`` option disabled as cells exhibit sharp morpho-tonal transitions during spreading events that may break the tracking. For the post-processing on tracks, a minimum tracklength > 3 is always recommended to avoid FP tracks. The ``Interpolate missed detections within tracks`` should be ticked to fill track gaps efficiently. Finally, with the spreading assays, it is often convenient to ``Sustain first position from the beginning of the movie`` to be able to measure intensities prior to cell arrival close to the surface. Click on ``Save`` to save the tracking configuration.

1) untoggle the ``SEGMENT`` option if it is still active
2) toggle the ``TRACK`` option
3) press ``Submit`` to launch the job to the positions selected at the top


Quality check
~~~~~~~~~~~~~

Upon completion, you can select a single position and click on the eye icon of the tracking module to the the raw bTrack results (before post-processing). The cells are relabelled inplace with their track ID, in such a way that tracked cells keep the same color over time.


Measure
-------

As for the tracking step, you can click on the configuration button of the measurement module to see the programmed measurements. Here we chose to measure the area, mean intensity and all the texture features for the cells, as well as the position-based intensity estimate in a circle or radius 10 px.

1) untoggle the ``SEGMENT`` and ``TRACKING`` options if they are still active
2) toggle the ``MEASURE`` option
3) press ``Submit`` to launch the job to the positions selected at the top

At this stage you have several options to pursue your data exploration and analysis.

1) Classification: use the classifier module (the three dots icon) to classify the cells and use the tracks to determine event times
2) Table exploration: click on ``View table`` to perform track collapses and plot distributions for the different measurements
3) In-situ exploration: use the static annotator (eye icon) to click on single cells on the images and view how their measurements compare to the ones of the other cells (both on the same image and in the whole dataset)

All these options can be used complementarily for a true single-cell analysis.

Classification
~~~~~~~~~~~~~~

Click on the three-dots icon to open the classifier module. Give a name to the class of interest. Here we can try to determine spread cells from hovering cells. Call the class ``spread``. 

You can now set two features of interest to construct a phase space. Each cell measurement is a point in this phase space. The frame slider allows you to see how these measurements shift in time. The integral-symbol button at the top-right corner allows to display all measurements from all timepoints on the same plane. 

Set ``adhesion_channel_circle_10_mean`` as the first feature and ``area`` as the second. Use the frame slider to see how the measurements move over time. You may notice that bright and small cells sometimes transition to dark and large cells. Now click on the integral button. You can now clearly visualize the two clusters with a dividing line at around ``adhesion_channel_circle_10_mean ~ 1``.

Type the condition ``adhesion_channel_circle_10_mean < 0.98``  in the classify field and click on ``Submit...`` to view the classification result. In blue, the cells negative to the condition, in red the cells positive to the condition. This is an instantaneous classification.

Since we have tracks, we can investigate this classification over whole trajectories and see if we observe transitions. 

1) toggle the ``Time correlated`` option
2) toggle ``irreversible event``
3) set a R2 tolerance to 0.1
4) click on ``apply``. Wait for the window to close automatically.

Table exploration
~~~~~~~~~~~~~~~~~

Click on ``View table`` to view the trajectory table. You will find at the end of it three columns ``status_spread``, ``class_spread`` and ``t_spread``. By convention, the status is 0 before the event and 1 after. The class is an attribute for the whole trajectory. A class of 0 is a cell that exhibits an irreversible transition from 0 to 1, a class of 1 a cell that never transitions and a class of 2 a cell that transitioned before the beginning of the movie.

Type ``Ctrl+I`` to make a first plot. Here we forget about track identity and assemble all measurements as if the cells were independent. Toggle the ``strip`` and ``boxplot`` options. You may pass ``well_name`` as x, ``area`` as y and ``state_spread`` as hue. Click on ``set`` to generate your first plot!

Alternatively, since we have tracks, we can collapse the measurements to have the average in state 0 and average in state 1 of all measurements for each track. 

1) go to ``File > Group by tracks...``
2) toggle the ``per status`` option, select ``status_spread`` and choose ``mean`` for the projection
3) click on ``Apply``

A new table. Type ``Ctrl+P`` to plot from this table. The new quantities are now one estimator per state of each cell (so at most 3 values per cell). 

In-situ exploration
~~~~~~~~~~~~~~~~~~~

You can also click on the eye icon of the measurement module. This opens an interface where you can select the ``status_spread`` at the top and see, for each frame, how the cells were classified. If you click on a cell, you will see on the left side how its measurements compare to the reste of the cells on the image (the dots) or across the whole table (boxplot). 


Signal analysis
---------------

You may also click on the eye icon of the signal analysis module. Here, you will be able to interact with dynamic cell tracks and see the classification and event time that was estimated for the selected track. 

At the top, select the ``class_spread``. You can click on a cell. On the left side you will see the signals associated to the cell. You may correct the classification and estimate a new event time if relevant. Upon saving, the new values are written in the table. 

Survival
--------

Go the the ``Analyze`` tab. You have now two times of interest. The time of first detection that corresponds to when the first mask is detected for each cell, and the spread time. You can click on ``plot survival`` to make a survival function representation of that distribution of times and events.

1) set the population to ``effectors``
2) leave the time of reference as ``t_firstdetection``
3) set the time of interest to ``t_spread``
4) press ``Submit``